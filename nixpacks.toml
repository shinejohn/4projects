# =============================================================================
# NIXPACKS.TOML - Fibonacco AI Platform (Laravel 12 + Vue 3)
# =============================================================================
# Railway build configuration for unified backend platform
# =============================================================================

[phases.setup]
# All PHP extensions required for Laravel 12
nixPkgs = [
    # PHP 8.3 core
    "php83",
    
    # Database extensions
    "php83Extensions.pdo",
    "php83Extensions.pdo_pgsql",
    "php83Extensions.pgsql",
    
    # Cache/Queue extensions
    "php83Extensions.redis",
    
    # Process control (required for Horizon)
    "php83Extensions.pcntl",
    
    # Common extensions
    "php83Extensions.bcmath",
    "php83Extensions.gd",
    "php83Extensions.intl",
    "php83Extensions.mbstring",
    "php83Extensions.xml",
    "php83Extensions.dom",
    "php83Extensions.zip",
    "php83Extensions.curl",
    "php83Extensions.fileinfo",
    "php83Extensions.tokenizer",
    "php83Extensions.ctype",
    "php83Extensions.openssl",
    "php83Extensions.sodium",
    
    # Node.js 20 for frontend builds
    "nodejs_20",
    "npm"
]

[phases.install]
# Install dependencies and build frontend assets
cmds = [
    # Install PHP dependencies (production only, optimized)
    "composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist",
    
    # Install Node dependencies
    "npm ci --prefer-offline --no-audit",
    
    # Build frontend assets (if any)
    "npm run build || true",
    
    # Create storage directories
    "mkdir -p storage/framework/sessions",
    "mkdir -p storage/framework/views",
    "mkdir -p storage/framework/cache/data",
    "mkdir -p storage/logs",
    "mkdir -p bootstrap/cache",
    
    # Set permissions
    "chmod -R 775 storage bootstrap/cache"
]

[phases.build]
# Laravel optimizations (only if APP_ENV is set)
cmds = [
    "php artisan config:cache || true",
    "php artisan route:cache || true",
    "php artisan view:cache || true",
    "php artisan event:cache || true"
]

[start]
# Default start command for web service
# Runs migrations, creates storage link, starts server
cmd = "php artisan migrate --force && php artisan storage:link --force || true && php artisan serve --host=0.0.0.0 --port=${PORT:-8080}"
